####################
### PS2 NOTEBOOK ###  
####################

  #########################
  # author: Kaden Coulter #
  # date: 2025-09-03      #
  # PS2 Bi623 KCGIPBG     #
  #########################

  ### QAA ENV ### 
    List of packages in environment: "/gpfs/home/kcoulter/miniforge3/envs/QAA"
    Name                       Version       Build                 Channel   
    cutadapt                   5.1           py312h0fa9677_0       bioconda  
    fastqc                     0.12.1        hdfd78af_0            bioconda   
    matplotlib                 3.10.6        py312h7900ff3_1       conda-forge
    numpy                      2.3.2         py312h33ff503_2       conda-forge
    trimmomatic                0.40          hdfd78af_0            bioconda 
  
  ### PART 1 ###
  
    # ASSIGNED : SRR25630309 and SRR25630393
    
    # LOOKUP: @ NCBI SRA
    
    # FILENAMES:
      SRR25630309	Cco_com123_EO_6cm_1	Cco_com123_EO_6cm_1_htseqcounts_[forORrev]stranded.txt
      SRR25630393	Crh_rhy116_EO_adult_3	Crh_rhy116_EO_adult_3_htseqcounts_[forORrev]stranded.txt
    
    # FETCH -> FASTA
      $ prefetch SRR25630309
      $ prefetch SRR25630393
      $ fasterq-dump SRR25630393 --split-files --progress
      $ fasterq-dump SRR25630309 --split-files --progress
      
    # ! TO OPEN HTML NAV TO LOCAL AND USE OPEN <FILENAME>.html
    
    # WHEN REVIEWING THE HTML AND DECIDING WHAT TO DO:
      https://www.bioinformatics.babraham.ac.uk/projects/fastqc/Help/3%20Analysis%20Modules/
    
    Based on the data quality and the dismissal of all raised warnings, we can 
    continue to analyze this data. Everything looks as expected for the type of 
    sequencing we used to generate this data, the data is high quality, and 
    nothing seems questionable or suspicious. Continue with analysis!
    
    # PLOT GENERATION USING .PY AND .SH #
    
      Copied bioinfo.py qual_by_nuc.py qual_by_nuc_slurm.sh and edited qual_by 
      
      Note: Requesting 70 QB of Memory in Slurm. 
            Know that scripts are inefficient but something seems off...
            
      Submitted batch job 37909622: Should be good...
        Was catting into a var and then reading... taking too much mem
        
      ISSUE SOLVED: WAS PASSING FASTA LENGTH NOT READ:
      
      $ gzip -dc Cco_com123_EO_6cm_1_1.fastq.gz | head -n 4 | awk '{ print length($0) }' ## 150
      
      FINAL OUT:
      
        	Command being timed: "./qual_by_nuc.py -f Cco_com123_EO_6cm_1_1.fastq.gz -k 150 -o Cco_1_1"
        	User time (seconds): 145.52
        	System time (seconds): 0.14
        	Percent of CPU this job got: 95%
        	Elapsed (wall clock) time (h:mm:ss or m:ss): 2:31.80
        	Exit status: 0
        
    
    
  ### PART 2 ###
  
    ### PACKAGES ###
      $ cutadapt --version ## 5.1
      $ trimmomatic -version ## 0.40
      ##  I am going to assume that these versions are okay and move forward. Will return if any errors occur. 
    
    ### CUTADAPT 1 OUTPUT ###
    
        Done           00:00:39     3,735,980 reads @  10.6 µs/read;   5.67 M reads/minute
        
        === Summary ===
        
        Total read pairs processed:          3,735,980
          Read 1 with adapter:                 589,610 (15.8%)
          Read 2 with adapter:                 610,016 (16.3%)
        Pairs written (passing filters):     3,735,980 (100.0%)
        
        Total basepairs processed: 1,120,794,000 bp
          Read 1:   560,397,000 bp
          Read 2:   560,397,000 bp
        Total written (filtered):  1,094,083,321 bp (97.6%)
          Read 1:   546,818,038 bp
          Read 2:   547,265,283 bp
        
        === First read: Adapter 1 ===
        
        Sequence: AGATCGGAAGAGCACACGTCTGAACTCCAGTCA; Type: regular 3'; Length: 33; Trimmed: 589610 times
        
        Minimum overlap: 3
        No. of allowed errors:
        1-9 bp: 0; 10-19 bp: 1; 20-29 bp: 2; 30-33 bp: 3
        
        Bases preceding removed adapters:
          A: 11.1%
          C: 26.7%
          G: 47.2%
          T: 15.0%
          none/other: 0.0%
        
        === Second read: Adapter 2 ===
        
        Sequence: AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT; Type: regular 3'; Length: 33; Trimmed: 610016 times
        
        Minimum overlap: 3
        No. of allowed errors:
        1-9 bp: 0; 10-19 bp: 1; 20-29 bp: 2; 30-33 bp: 3
        
        Bases preceding removed adapters:
          A: 9.3%
          C: 21.8%
          G: 58.4%
          T: 10.5%
          none/other: 0.0%
          
    ### CUTADAPT 2 OUTPUT ###
    
      Done           00:05:29    32,594,028 reads @  10.1 µs/read;   5.94 M reads/minute

      === Summary ===
      
      Total read pairs processed:         32,594,028
        Read 1 with adapter:               4,264,287 (13.1%)
        Read 2 with adapter:               4,455,966 (13.7%)
      Pairs written (passing filters):    32,594,028 (100.0%)
      
      Total basepairs processed: 9,778,208,400 bp
        Read 1: 4,889,104,200 bp
        Read 2: 4,889,104,200 bp
      Total written (filtered):  9,593,951,183 bp (98.1%)
        Read 1: 4,795,698,545 bp
        Read 2: 4,798,252,638 bp
      
      === First read: Adapter 1 ===
      
      Sequence: AGATCGGAAGAGCACACGTCTGAACTCCAGTCA; Type: regular 3'; Length: 33; Trimmed: 4264287 times
      
      Minimum overlap: 3
      No. of allowed errors:
      1-9 bp: 0; 10-19 bp: 1; 20-29 bp: 2; 30-33 bp: 3
      
      Bases preceding removed adapters:
        A: 11.9%
        C: 25.1%
        G: 48.4%
        T: 14.6%
        none/other: 0.0%
        
      === Second read: Adapter 2 ===
      
      Sequence: AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT; Type: regular 3'; Length: 33; Trimmed: 4455966 times
      
      Minimum overlap: 3
      No. of allowed errors:
      1-9 bp: 0; 10-19 bp: 1; 20-29 bp: 2; 30-33 bp: 3
      
      Bases preceding removed adapters:
        A: 10.7%
        C: 24.8%
        G: 53.6%
        T: 10.9%
        none/other: 0.0%

    ### SANITY CHECK ###
    
      $ zcat Cco_com123_EO_6cm_1_1.fastq.gz | grep -c AGATCGGAAGAGCACACGTCTGAACTCCAGTCA ## 147375
      $ zcat Cco_com123_EO_6cm_1_2.fastq.gz | grep -c AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT ## 55585
      $ zcat Crh_rhy116_EO_adult_3_1.fastq.gz | grep -c AGATCGGAAGAGCACACGTCTGAACTCCAGTCA ## 964952
      $ zcat Crh_rhy116_EO_adult_3_2.fastq.gz | grep -c AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT ## 311694
      ## WHEN YOU SWITCH THE ADAPTERS TO WHAT WE NOW KNOW IS BACKWARDS, WE DO NOT FIND THEM IN THE FILE
      $ zcat Cco_com123_EO_6cm_1_1.fastq.gz | grep -c AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT ## 0 
      $ zcat Cco_com123_EO_6cm_1_2.fastq.gz | grep -c AGATCGGAAGAGCACACGTCTGAACTCCAGTCA ## 0
      $ zcat Crh_rhy116_EO_adult_3_2.fastq.gz | grep -c AGATCGGAAGAGCACACGTCTGAACTCCAGTCA ## 0
      $ zcat Crh_rhy116_EO_adult_3_1.fastq.gz | grep -c AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT ## 0 
      
    ### TRIMMOMATIC OUTPUTS ###
    
      Quality encoding detected as phred33
      Input Read Pairs: 3735980 Both Surviving: 3695585 (98.92%) Forward Only Surviving: 29316 (0.78%) Reverse Only Surviving: 9603 (0.26%) Dropped: 1476 (0.04%)
      TrimmomaticPE: Completed successfully
      
      Quality encoding detected as phred33
      Input Read Pairs: 32594028 Both Surviving: 32425688 (99.48%) Forward Only Surviving: 111529 (0.34%) Reverse Only Surviving: 51935 (0.16%) Dropped: 4876 (0.01%)
      TrimmomaticPE: Completed successfully
      
    ### PLOTS ###
    
      Created read_len_dist.py and read_len_dist_slurm.sh to create what is needed -> EVEN HAS COLOR OPTION :D
      -> Give it a bit of memory to run all 4 at the same time. 
      
      Consider going back and cleaning up the plot for Cco_1.png or whatever I named it... not super pretty. 
      
      OH -> I don't need multiple CPUs Fix this in this sh
      
  ### PART 3 ###
  
    # 10 and 11, STAR
      $ mamba install Star
      $ mamba install Picard
      $ mamba install Samtools
      $ mamba install NumPy
      $ mamba install Matplotlib
      $ mamba install HTSeqs
    
      $ mamba install gffread
      $ cp /projects/bgmp/shared/Bi623/PS2/campylomormyrus.fasta .
      $ cp /projects/bgmp/shared/Bi623/PS2/campylomormyrus.gff .
      $ gffread campylomormyrus.gff -T -o campylomormyrus.gtf
      
      	/gpfs/home/kcoulter/miniforge3/envs/QAA/bin/STAR-avx2 --runThreadN 8 --runMode genomeGenerate --genomeDir /projects/bgmp/kcoulter/bioinfo/Bi623/QAA/campy_data/align_db/ --genomeFastaFiles /projects/bgmp/kcoulter/bioinfo/Bi623/QAA/campy_data/campylomormyrus.fasta --sjdbGTFfile /projects/bgmp/kcoulter/bioinfo/Bi623/QAA/campy_data/campylomormyrus.gtf
        STAR version: 2.7.11b   compiled: 2025-07-24T03:06:21+0000 :/opt/conda/conda-bld/star_1753326220084/work/source

        Sep 04 19:36:49 ..... started STAR run
        Sep 04 19:36:49 ... starting to generate Genome files
        Sep 04 19:36:56 ..... processing annotations GTF
        !!!!! WARNING: --genomeSAindexNbases 14 is too large for the genome size=862592683, which may cause seg-fault at the mapping step. Re-run genome generation with recommended --genomeSAindexNbases 13
        Sep 04 19:36:59 ... starting to sort Suffix Array. This may take a long time...
        Sep 04 19:37:04 ... sorting Suffix Array chunks and saving them to disk...
        
      # CREATED database_builder.sh
      # CREATED starliner.sh
      
    # SAMTOOLS TO BAM AND PICARD
      $ mamba install samtools
      $ samtools sort -@ 4 -o Campy_Cco_com123_sorted.bam Campy_Cco_com123_alignedAligned.out.sam
        [bam_sort_core] merging from 0 files and 4 in-memory blocks...
      $ samtools sort -@ 4 -o Campy_Crh_rhy116_sorted.bam Campy_Crh_rhy116_alignedAligned.out.sam 
        [bam_sort_core] merging from 7 files and 4 in-memory blocks...
      
      
      !!! NOTE: STRANGE THINGS ARE GOING ON WITH PICARD. !!!
        $ mamba create -n stupidpicard python=3.6
        $ mamba activate stupidpicard
        $ mamba install -c conda-forge -c bioconda picard=2.18.0
        
        $ picard MarkDuplicates     INPUT=Campy_Cco_com123_sorted.bam     OUTPUT=Campy_Cco_com123_sort_marked.bam     METRICS_FILE=Cco_com123_picard.metrics     REMOVE_DUPLICATES=TRUE     VALIDATION_STRINGENCY=LENIENT
          ## htsjdk.samtools.metrics.StringHeader
          # Started on: Thu Sep 04 22:50:19 PDT 2025
          
          ## METRICS CLASS	picard.sam.DuplicationMetrics
          LIBRARY	UNPAIRED_READS_EXAMINED	READ_PAIRS_EXAMINED	SECONDARY_OR_SUPPLEMENTARY_RDS	UNMAPPED_READS	UNPAIRED_READ_DUPLICATES	READ_PAIR_DUPLICATES	READ_PAIR_OPTICAL_DUPLICATES	PERCENT_DUPLICATION	ESTIMATED_LIBRARY_SIZE
          Unknown Library	7738	3412953	1105531	558103	4710	1280227	0	0.375373	3321328
        
        $ picard MarkDuplicates \
            INPUT=Campy_Crh_rhy116_sorted.bam \
            OUTPUT=Campy_Crh_rhy116_sort_marked.bam \
            METRICS_FILE=Campy_Crh_rhy116_picard.metrics \
            REMOVE_DUPLICATES=TRUE \
            VALIDATION_STRINGENCY=LENIENT
            
    # sam_reporter.py STAT RETURNS
      $ samtools view -h -o Campy_Crh_rhy116_sort_marked.sam Campy_Crh_rhy116_sort_marked.bam
      $ samtools view -h -o Campy_Cco_com123_sort_marked.sam Campy_Cco_com123_sort_marked.bam
      $ cp /projects/bgmp/kcoulter/bioinfo/Bi621/PS/PS8/ps8-kbcoulter/sam_reporter.py . ## THEN EDIT IT
      $ chmod 755 sam_reporter.py 
      $ python sam_reporter.py -f star_aligned/Campy_Cco_com123_sort_marked.sam star_aligned/Campy_Crh_rhy116_sort_marked.sam
        
    # COUNTS USING htseq-count 
      -> Created htseq_slurm.sh
      ### LOTS OF OUTS ###
        100000 GFF lines processed.
        200000 GFF lines processed.
        300000 GFF lines processed.
        400000 GFF lines processed.
        500000 GFF lines processed.
        589011 GFF lines processed.
        Warning: Read SRR25630393.26969323 claims to have an aligned mate which could not be found in an adjacent line.
        ...
        For all Files -> No Failure or Error Message. This looks good to me!
        
    # STRAND SPECIFIC ANALYSIS:
      CREATED strand_tester.py to provide some insight...
  
      $ python strand_tester.py -f ../htseq_files/Crh_rhy116_EO_adult_3_htseqcounts_[forORrev]stranded.txt ../htseq_files/Crh_rhy116_EO_adult_3_htseqcounts_[forORrev]reverse.txt
          #####################################################################
          ASSUMING STRANDED YES: ../htseq_files/Crh_rhy116_EO_adult_3_htseqcounts_[forORrev]stranded.txt 
           
                  AND 
           
          REVERSE ASSUMING: ../htseq_files/Crh_rhy116_EO_adult_3_htseqcounts_[forORrev]reverse.txt
          #####################################################################
          Total reads assigned (stranded=yes): 928660
          Total reads assigned (stranded=reverse): 19659636
          
          Recommendation: use stranded='reverse'
          #####################################################################
          
          OF 31081660
      
      $ python strand_tester.py -f ../htseq_files/Cco_com123_EO_6cm_1_htseqcounts_[forORrev]stranded.txt ../htseq_files/Cco_com123_EO_6cm_1_htseqcounts_[forORrev]reverse.txt
          #####################################################################
          ASSUMING STRANDED YES: ../htseq_files/Cco_com123_EO_6cm_1_htseqcounts_[forORrev]stranded.txt 
           
                  AND 
           
          REVERSE ASSUMING: ../htseq_files/Cco_com123_EO_6cm_1_htseqcounts_[forORrev]reverse.txt
          #####################################################################
          Total reads assigned (stranded=yes): 97989
          Total reads assigned (stranded=reverse): 2026304
          
          Recommendation: use stranded='reverse'
          #####################################################################
          
          OF 3412953	

### ONLY FORMATTING REPORT LEFT ###

################   
### COMPLETE ###
################